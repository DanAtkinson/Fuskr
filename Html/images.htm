<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='/Scripts/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
		</script>
		<script type="text/javascript"src="/Scripts/jquery.tmpl.min.js"></script>
		<script type="text/javascript"src="/Scripts/Fuskr.js"></script>
		<style>
			.error { display: none; }
			.hide { display:none; }
		</style>
		<link rel="stylesheet" href="/Styles/styles.css" type="text/css">
		<script id="imageTemplate" type="text/x-jquery-tmpl">
			<div class="hide wrap" id="image_${Index}">
				<a href="#" class="nextImage">
					<img class="fuskImage" alt="${Link}" src="${Link}">
				</a>
				<a href="#" class="resizeImage">Resize</a>
				<div>				
					<div>
						<a href="${Link}" target="_blank" title="Click to open this image in a new tab">${Link}</a>
					</div>
					<div>
						(Click image for next picture) | 
						<a href="#top" title="Go to top of page">Top</a> | 
						<a href="#bottom" title="Go to bottom of page">Bottom</a> |
						{{if Index > 0}}<a href="#" class="previousImage" title="Previous Image">&lt;</a> | {{/if}}
						{{if Index < Total-1}}<a href="#" class="nextImage" title="Next Image">&gt;</a> {{/if}}
					</div>
				</div>
			</div>
		</script>
	</head>
	<body>
		<div id="all">
			<div id="top" class="info">
				<p><span class="total">0</span> Images | <span class="loaded">0</span> Loaded | <span class="broken">0</span> Failed</p>
				<p><a href="#" class="toggleBrokenLinks"><span class="showHide">Show</span> broken images</a></p>
				<p><a href="#" class="resizeImages">Resize images to fit on page</a></p>
				<p class="fuskUrl">&nbsp;</p>
			</div>
			<div id="content">
			</div>
			<div id="bottom" class="info">
				<p><span class="total">0</span> Images | <span class="loaded">0</span> Loaded | <span class="broken">0</span> Failed</p>
				<p><a href="#" class="toggleBrokenLinks"><span class="showHide">Show</span> broken images</a></p>
				<p><a href="#" class="resizeImages">Resize images to fit on page</a></p>
				<p class="fuskUrl">&nbsp;</p>
			</div>
		</div>
		<script type="text/javascript">
			(function() {
				var brokenImagesCount = 0,
					loaded = 0,
					resizeOn = false,
					showHiddenImages = false;

				$(function() {

					var currentUrl = (function() {
						var query = window.location.search.substring(1);
						var vars = query.split("&");
						for (var i = 0; i < vars.length; i++) {
							var pair = vars[i].split("=");
							if (pair[0] == "url") {
								return pair[1];
							}
						}
					})();

					document.title = "Fuskr - " + currentUrl;

					$("p.fuskUrl").html(currentUrl);

					var parsedLinks = Fuskr.GetLinks(currentUrl);

					var linkData = $.map(parsedLinks, function(item,i){
						return { "Index" : i, "Link" : item, "Total" : parsedLinks.length };
					});

					$("div.info span.total").html(linkData.length);

					$("#imageTemplate").tmpl(linkData).appendTo("#content");

					//Start the images hidden and show as each one loads.
					$("div#content img.fuskImage").load(function () {
						$("div.info span.loaded").html(loaded++);
						$(this).parents("div.wrap").removeClass("hide").addClass("loaded");
					});

					//Get the users current option regarding showing images in their full resolution or scaling them to the current window size.
					$("a.resizeImages").click(function() {
						resizeOn = !resizeOn;

						if(resizeOn) {
							$("div.wrap img").css("width","100%");
							$(this).text("Resize images to full width");
						} else {
							$("div.wrap img").css("width","");
							$(this).text("Resize images to fit on page");
						}
						return false;
					});

					$("a.resizeImage").click(function(e) {
						e.preventDefault();
						if($(this).hasClass("resized")) {
							$(this).removeClass("resized");
							$(this).parent().find("img").css("width","");
						} else {
							$(this).addClass("resized").parent().find("img").css("width","100%");
						}
						return false;
					});

					$("a.toggleBrokenLinks").click(function(e) {
						e.preventDefault();
						showHiddenImages = true;
						$(this).find("span.showHide").html(!document.styleSheets[0].disabled ? "Hide" : "Show");
						document.styleSheets[0].disabled = !document.styleSheets[0].disabled;
						return false;
					});

					$("a.previousImage").click(function(e){
						e.preventDefault();
						scrollTo($(this), -1);
					});

					$("a.nextImage").click(function(e){
						e.preventDefault();
						scrollTo($(this), 1);
					});

					function scrollTo(element, direction){
						//get the top offset of the target anchor
						var offset = 0;
						if(direction === 1){
							offset = element.parents("div.wrap").next(showHiddenImages ? "div.wrap" : "div.loaded").offset();
						} else {
							offset = element.parents("div.wrap").prev(showHiddenImages ? "div.wrap" : "div.loaded").offset();
						}

						//goto that anchor by setting the body scroll top to anchor top
						$('html, body').animate({scrollTop:offset.top}, 500);
					}

					$("img.fuskImage").error(function() {
						brokenImagesCount++;
						$(this).closest(".wrap").addClass("error");
						$("div.info span.broken").html(brokenImagesCount);
					});
				});
			})();
		</script>
	</body>
</html>