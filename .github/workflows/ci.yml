name: CI/CD Pipeline

on:
 push:
  branches: [master, main, develop]
 pull_request:
  branches: [master, main]

jobs:
 test:
  name: Test & Build
  runs-on: ubuntu-latest

  strategy:
   matrix:
    node-version: [20.19.x, 22.12.x, 22.x]

  steps:
   - name: ğŸ“ Checkout repository
     uses: actions/checkout@v6

   - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
     uses: actions/setup-node@v6
     with:
      node-version: ${{ matrix.node-version }}
      cache: 'npm'

   - name: ğŸ”§ Install dependencies
     run: npm ci

   - name: ğŸ§ª Run tests
     run: npm test -- --no-watch --no-progress --browsers=ChromeHeadless

   - name: ğŸ—ï¸ Build project
     run: npm run build

   - name: ğŸ“Š Upload coverage reports
     if: matrix.node-version == '22.x'
     uses: codecov/codecov-action@v5
     with:
      file: ./coverage/lcov.info
      flags: unittests
      name: codecov-umbrella
      fail_ci_if_error: false

 lint:
  name: Code Quality
  runs-on: ubuntu-latest

  steps:
   - name: ğŸ“ Checkout repository
     uses: actions/checkout@v6

   - name: ğŸ“¦ Setup Node.js
     uses: actions/setup-node@v6
     with:
      node-version: '22.x'
      cache: 'npm'

   - name: ğŸ”§ Install dependencies
     run: npm ci

   - name: ğŸ” Run linter
     run: |
      echo "Running lint check..."
      npm run lint || echo "âš ï¸ Lint issues found - see output above. This does not fail the build."
      echo "âœ… Lint check completed"

   - name: ğŸ¨ Check code formatting
     run: |
      echo "Checking code formatting with Prettier..."
      npm run format:check

 build-extensions:
  name: Build Browser Extensions
  runs-on: ubuntu-latest
  needs: [test, lint]

  steps:
   - name: ğŸ“ Checkout repository
     uses: actions/checkout@v6

   - name: ğŸ“¦ Setup Node.js
     uses: actions/setup-node@v6
     with:
      node-version: '22.x'
      cache: 'npm'

   - name: ğŸ”§ Install dependencies
     run: npm ci

   - name: ğŸ—ï¸ Build for production
     run: npm run build

   - name: ğŸ“¦ Package Chrome extension
     run: |
      if [ -f "package-chrome.json" ]; then
        npm run package:chrome
      else
        echo "Chrome packaging script not found, skipping"
      fi

   - name: ğŸ¦Š Package Firefox extension
     run: |
      if [ -f "package-firefox.json" ]; then
        npm run package:firefox
      else
        echo "Firefox packaging script not found, skipping"
      fi

   - name: ğŸ“¤ Upload build artifacts
     uses: actions/upload-artifact@v4
     with:
      name: extension-builds
      path: |
       dist/
       *.zip
      retention-days: 30
